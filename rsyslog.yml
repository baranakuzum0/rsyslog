---
- name: RSYSLOG + Auditd + Bash Log Kurulumu (Ubuntu/Debian)
  hosts: all
  become: yes
  vars:
    bash_log_file: /var/log/bash.log
    remote_syslog_ip: "192.168.121.21"

  tasks:

    # --------------------------
    # 1Ô∏è‚É£ Paket Kurulumu
    # --------------------------
    - name: Auditd ve Audispd-plugins kurulumu (varsa atla)
      apt:
        name:
          - auditd
          - audispd-plugins
        state: present
        update_cache: yes

    # --------------------------
    # 2Ô∏è‚É£ Servisler
    # --------------------------
    - name: Rsyslog servisinin aktif ve √ßalƒ±≈üƒ±r olmasƒ±nƒ± saƒüla
      systemd:
        name: rsyslog
        enabled: yes
        state: started

    - name: Auditd servisinin aktif ve √ßalƒ±≈üƒ±r olmasƒ±nƒ± saƒüla
      systemd:
        name: auditd
        enabled: yes
        state: started

    # --------------------------
    # 3Ô∏è‚É£ Bash log fonksiyonu
    # --------------------------
    - name: Bash log fonksiyonunu /etc/profile dosyasƒ±na ekle (varsa atla)
      blockinfile:
        path: /etc/profile
        block: |
          # Bash Log
          PORT=$(who am i | awk '{print $5}' | tr -d '()')
          function history_to_syslog {
              local cmd=$(history 1 | awk '{$1=""; print substr($0,2)}')
              local p_dir=$(pwd)
              local LOG_NAME=$LOGNAME
              if [ "$cmd" != "$old_command" ]; then
                  logger -p local5.debug -- Bash SESSION=$$, from_remote_host=$PORT, USER=$LOG_NAME, PWD=$p_dir, CMD="$cmd"
              fi
              old_command=$cmd
          }
          trap history_to_syslog DEBUG
        marker: "# ANSIBLE-BASH-PROFILE-BEGIN"

    - name: Bash log fonksiyonunu /root/.bashrc dosyasƒ±na ekle (varsa atla)
      blockinfile:
        path: /root/.bashrc
        block: |
          # Bash Log
          PORT=$(who am i | awk '{print $5}' | tr -d '()')
          function history_to_syslog {
              local cmd=$(history 1 | awk '{$1=""; print substr($0,2)}')
              local p_dir=$(pwd)
              local LOG_NAME=$LOGNAME
              if [ "$cmd" != "$old_command" ]; then
                  logger -p local5.debug -- Bash SESSION=$$, from_remote_host=$PORT, USER=$LOG_NAME, PWD=$p_dir, CMD="$cmd"
              fi
              old_command=$cmd
          }
          trap history_to_syslog DEBUG
        marker: "# ANSIBLE-BASH-RC-BEGIN"

    # --------------------------
    # 4Ô∏è‚É£ Audit plugin aktif et
    # --------------------------
    - name: Audit log pluginini aktif et (varsa atla)
      lineinfile:
        path: /etc/audisp/plugins.d/syslog.conf
        regexp: '^active\s*='
        line: 'active = yes'
        backrefs: yes
      ignore_errors: yes

    # --------------------------
    # 5Ô∏è‚É£ Rsyslog.conf audit log temizle eski bloklar
    # --------------------------
    - name: Eski RSYSLOG QRADAR + AUDIT bloklarƒ±nƒ± temizle
      replace:
        path: /etc/rsyslog.conf
        regexp: '^(# BEGIN RSYSLOG QRADAR \+ AUDIT.*?# END RSYSLOG QRADAR \+ AUDIT)'
        replace: ''
        flags: 'ms'

    - name: Eski ANSIBLE-RSYSLOG-AUDIT-BEGIN bloklarƒ±nƒ± temizle
      replace:
        path: /etc/rsyslog.conf
        regexp: '^(# ANSIBLE-RSYSLOG-AUDIT-BEGIN.*?# ANSIBLE-RSYSLOG-AUDIT-BEGIN)'
        replace: ''
        flags: 'ms'

    # --------------------------
    # 6Ô∏è‚É£ Rsyslog.conf audit log ekle tek blok
    # --------------------------
    - name: Rsyslog.conf √ºzerine tek audit log bloƒüunu ekle
      blockinfile:
        path: /etc/rsyslog.conf
        block: |
          # BEGIN RSYSLOG QRADAR + AUDIT
          ############  RSYSLOG  QRADAR
          {{ remote_syslog_ip }}

          ########################## FOR AUDITD
          # audit log
          $ModLoad imfile
          $InputFileName /var/log/audit/audit.log
          $InputFileTag tag_audit_log_$HOSTNAME:
          $InputFileStateFile audit_log
          $InputFileSeverity info
          $InputFileFacility local6
          $InputRunFileMonitor
          # END RSYSLOG QRADAR + AUDIT
        marker: "# ANSIBLE-RSYSLOG-AUDIT-BEGIN"
        insertafter: EOF

    # --------------------------
    # 7Ô∏è‚É£ Bash log dosyasƒ±
    # --------------------------
    - name: Bash log dosyasƒ±nƒ± olu≈ütur (varsa atla)
      file:
        path: "{{ bash_log_file }}"
        state: touch
        owner: root
        group: adm
        mode: '0640'

    # --------------------------
    # 8Ô∏è‚É£ Rsyslog bash log config
    # --------------------------
    - name: Rsyslog bash log config dosyasƒ±nƒ± olu≈ütur (varsa atla)
      copy:
        dest: /etc/rsyslog.d/bash.conf
        content: |
          # Bash log
          local5.debug {{ bash_log_file }}
        force: no

    # --------------------------
    # 9Ô∏è‚É£ 50-default.conf g√ºncelle
    # --------------------------
    - name: 50-default.conf dosyasƒ±na kurallarƒ± ekle sadece eksikse
      blockinfile:
        path: /etc/rsyslog.d/50-default.conf
        block: |
          auth,authpriv.*                 /var/log/auth.log
          *.*;auth,authpriv.none          -/var/log/syslog
          cron.*                          /var/log/cron.log
          local1.*                        /var/log/sudo.log
          mail.err                         /var/log/mail.err
          *.emerg                          :omusrmsg:*
        marker: "# ANSIBLE-50-DEFAULT-CONF-BEGIN"
        insertafter: EOF

    # --------------------------
    # üîü Servisleri yeniden ba≈ülat
    # --------------------------
    - name: Rsyslog servisini yeniden ba≈ülat
      systemd:
        name: rsyslog
        state: restarted

    - name: Auditd servisini yeniden ba≈ülat
      systemd:
        name: auditd
        state: restarted
