---
- name: RSYSLOG + Auditd + Bash Log Kurulumu
  hosts: all
  become: yes

  vars:
    qradar_ip: "192.168.121.21"

    bash_log_entries:
      - "PORT=`who am i | awk '{ print $5 }' | sed 's/(//g' | sed 's/)//g'`"
      - 'logger -p local5.debug -t "Bash $LOGNAME $$" User $LOGNAME logged from $PORT'
      - 'function history_to_syslog {'
      - 'declare cmd'
      - 'declare p_dir'
      - 'declare LOG_NAME'
      - 'cmd=$(history 1)'
      - 'cmd=$(echo $cmd | awk "{print substr(\$0,length(\$1)+2)}")'
      - 'p_dir=$(pwd)'
      - 'LOG_NAME=$(echo $LOGNAME)'
      - 'if [ "$cmd" != "$old_command" ]; then'
      - 'logger -p local5.debug -- Bash SESSION=$$, from_remote_host=$PORT, USER=$LOG_NAME, PWD=$p_dir, CMD="${cmd}"'
      - 'fi'
      - 'old_command=$cmd'
      - '}'
      - 'trap history_to_syslog DEBUG || EXIT'

    rsyslog_lines:
      - { line: "*.* @@{{ qradar_ip }}:514", regexp: '^\*.\* @@' }
      - { line: "$ModLoad imfile", regexp: '^\$ModLoad imfile' }
      - { line: "$InputFileName /var/log/audit/audit.log", regexp: '^\$InputFileName /var/log/audit/audit.log' }
      - { line: "$InputFileTag tag_audit_log_.$hostname:", regexp: '^\$InputFileTag tag_audit_log_.*' }
      - { line: "$InputFileStateFile audit_log", regexp: '^\$InputFileStateFile audit_log' }
      - { line: "$InputFileSeverity info", regexp: '^\$InputFileSeverity info' }
      - { line: "$InputFileFacility local6", regexp: '^\$InputFileFacility local6' }
      - { line: "$InputRunFileMonitor", regexp: '^\$InputRunFileMonitor' }

    default_conf_lines:
      - { line: "auth,authpriv.*                 /var/log/auth.log", regexp: '^auth,authpriv\.\*' }
      - { line: "*.*;auth,authpriv.none          -/var/log/syslog", regexp: '^\*\.\*;auth,authpriv\.none' }
      - { line: "cron.*                          /var/log/cron.log", regexp: '^cron\.\*' }
      - { line: "local1.*                        /var/log/sudo.log", regexp: '^local1\.\*' }
      - { line: "mail.err                        /var/log/mail.err", regexp: '^mail\.err' }
      - { line: "*.emerg                         :omusrmsg:*", regexp: '^\*\.emerg' }

  tasks:

    - name: Auditd kurulumu
      apt:
        name: auditd
        state: present
        update_cache: yes

    - name: Auditd servisini aktif et
      service:
        name: auditd
        state: started
        enabled: yes

    - name: Rsyslog servisini aktif et
      service:
        name: rsyslog
        state: started
        enabled: yes

    - name: Audit syslog plugin aktif et
      lineinfile:
        path: /etc/audit/plugins.d/syslog.conf
        regexp: '^active\s*='
        line: 'active = yes'
        create: yes

    - name: Bash log dosyasını oluştur (yoksa)
      file:
        path: /var/log/bash.log
        state: touch
        owner: root
        group: adm
        mode: '0640'

    - name: Bash log script eksik satırları ekle (/etc/profile)
      lineinfile:
        path: /etc/profile
        line: "{{ item }}"
        insertafter: EOF
        state: present
      loop: "{{ bash_log_entries }}"

    - name: Bash log script eksik satırları ekle (/root/.bashrc)
      lineinfile:
        path: /root/.bashrc
        line: "{{ item }}"
        insertafter: EOF
        state: present
      loop: "{{ bash_log_entries }}"

    - name: Rsyslog bash konfig eksik mi kontrol
      shell: grep -q '^local5.debug\s\+/var/log/bash.log' /etc/rsyslog.d/bash.conf
      register: bash_rsyslog
      failed_when: false
      changed_when: false

    - name: Rsyslog bash konfig ekle (eksikse)
      copy:
        dest: /etc/rsyslog.d/bash.conf
        content: |
          local5.debug    /var/log/bash.log
        owner: root
        group: root
        mode: '0644'
      when: bash_rsyslog.rc != 0

    - name: Rsyslog.conf eksik QRadar + Auditd satırlarını ekle
      lineinfile:
        path: /etc/rsyslog.conf
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
        insertafter: EOF
        state: present
      loop: "{{ rsyslog_lines }}"

    - name: 50-default.conf eksik log kurallarını ekle
      lineinfile:
        path: /etc/rsyslog.d/50-default.conf
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
        state: present
      loop: "{{ default_conf_lines }}"

    - name: Rsyslog servisini yeniden başlat (her durumda)
      service:
        name: rsyslog
        state: restarted
